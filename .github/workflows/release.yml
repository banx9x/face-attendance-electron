name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller==6.18.0
          pip install fastapi==0.128.0 uvicorn==0.40.0 python-multipart==0.0.22
          pip install pydantic==2.12.5 pydantic-settings==2.12.0
          pip install flask==3.1.2 flask-cors==6.0.2
          pip install pillow==12.1.0 opencv-python==4.13.0.90 numpy==2.4.1
          pip install deepface==0.0.98 tensorflow==2.20.0 mtcnn==1.0.0 retina-face==0.0.17
          pip install pandas==3.0.0 requests==2.32.5
          pip install tf-keras==2.20.0

      - name: Build Python server (macOS)
        if: runner.os == 'macOS'
        run: bash scripts/build-server.sh

      - name: Build Python server (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: bash scripts/build-server.sh

      - name: Publish to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: yarn publish

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: out/make/**/*

  generate-update-metadata:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Wait for release assets
        run: sleep 30

      - name: Get release info and generate metadata
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="v${VERSION}"

          echo "Fetching release info for $TAG..."

          # Get release info
          RELEASE_JSON=$(gh api repos/${{ github.repository }}/releases/tags/$TAG)

          # Extract Windows Setup.exe info
          WIN_FILE=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("Setup\\.exe$")) | .name')
          WIN_SIZE=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("Setup\\.exe$")) | .size')
          WIN_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("Setup\\.exe$")) | .browser_download_url')

          # Extract macOS zip info
          MAC_FILE=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("darwin-arm64.*\\.zip$")) | .name')
          MAC_SIZE=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("darwin-arm64.*\\.zip$")) | .size')
          MAC_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("darwin-arm64.*\\.zip$")) | .browser_download_url')

          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          # For Windows: Calculate SHA512 by downloading (required by electron-updater)
          if [ -n "$WIN_FILE" ] && [ -n "$WIN_URL" ]; then
            echo "Downloading $WIN_FILE to calculate SHA512..."
            curl -L -o "$WIN_FILE" "$WIN_URL"
            
            WIN_SHA512=$(sha512sum "$WIN_FILE" | awk '{print $1}')
            WIN_SHA512_BASE64=$(echo -n "$WIN_SHA512" | xxd -r -p | base64 -w 0)
            
            echo "Windows SHA512: $WIN_SHA512"
            echo "Windows SHA512 (base64): $WIN_SHA512_BASE64"
            
            # Generate latest.yml for Windows
            cat > latest.yml <<EOF
          version: ${VERSION}
          files:
            - url: ${WIN_FILE}
              sha512: ${WIN_SHA512_BASE64}
              size: ${WIN_SIZE}
          path: ${WIN_FILE}
          sha512: ${WIN_SHA512_BASE64}
          releaseDate: ${RELEASE_DATE}
          EOF
            echo "✓ Created latest.yml with SHA512"
            cat latest.yml
            
            rm "$WIN_FILE"
          fi

          # For macOS: Calculate SHA512 by downloading
          if [ -n "$MAC_FILE" ] && [ -n "$MAC_URL" ]; then
            echo "Downloading $MAC_FILE to calculate SHA512..."
            curl -L -o "$MAC_FILE" "$MAC_URL"
            
            MAC_SHA512=$(sha512sum "$MAC_FILE" | awk '{print $1}')
            MAC_SHA512_BASE64=$(echo -n "$MAC_SHA512" | xxd -r -p | base64 -w 0)
            
            echo "macOS SHA512: $MAC_SHA512"
            echo "macOS SHA512 (base64): $MAC_SHA512_BASE64"
            
            # Generate latest-mac.yml for macOS
            cat > latest-mac.yml <<EOF
          version: ${VERSION}
          files:
            - url: ${MAC_FILE}
              sha512: ${MAC_SHA512_BASE64}
              size: ${MAC_SIZE}
          path: ${MAC_FILE}
          sha512: ${MAC_SHA512_BASE64}
          releaseDate: ${RELEASE_DATE}
          EOF
            echo "✓ Created latest-mac.yml with SHA512"
            cat latest-mac.yml
            
            rm "$MAC_FILE"
          fi

      - name: Upload metadata to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.VERSION }}"

          if [ -f "latest.yml" ]; then
            gh release upload "$TAG" latest.yml --clobber
            echo "✓ Uploaded latest.yml"
          fi

          if [ -f "latest-mac.yml" ]; then
            gh release upload "$TAG" latest-mac.yml --clobber
            echo "✓ Uploaded latest-mac.yml"
          fi

          echo ""
          echo "✅ Update metadata files have been added to the release!"

  # cleanup-release:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Remove source code assets
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         TAG=${GITHUB_REF#refs/tags/}
  #         gh release edit $TAG --draft=false

  #         # Delete source code assets if they exist
  #         gh release delete-asset $TAG "Source code (zip)" --yes 2>/dev/null || true
  #         gh release delete-asset $TAG "Source code (tar.gz)" --yes 2>/dev/null || true
